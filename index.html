<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…¨èƒ½æ•¸å­¸ç‹ - å°ˆæ¥­æ•™å­¸ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0fdf4; touch-action: manipulation; }
        .game-card { background: white; border-radius: 24px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); width: 100%; max-width: 450px; }
        .timer-bar { transition: width 1s linear; }
        .hidden { display: none !important; }
        input { -webkit-appearance: none; border-radius: 12px; outline: none; border: 3px solid #e2e8f0; text-align: center; transition: all 0.2s; }
        input:focus { border-color: #3b82f6; background-color: #eff6ff; transform: scale(1.05); }
        .fraction-line { width: 100%; height: 4px; background-color: #333; margin: 4px 0; border-radius: 2px; }
        .unit-step { font-size: 10px; color: #94a3b8; margin-top: 4px; }
        /* åˆ†æ•¸è¦–è¦ºåŒ–åœ–æ¡ˆ */
        .pie { width: 60px; height: 60px; border-radius: 50%; border: 2px solid #333; position: relative; overflow: hidden; background: #eee; }
        .slice { position: absolute; width: 100%; height: 100%; clip-path: polygon(50% 50%, 50% 0%, 100% 0%, 100% 100%, 0% 100%, 0% 0%, 50% 0%); }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app" class="w-full flex justify-center">
        
        <div id="topic-screen" class="game-card p-10 text-center">
            <div class="mb-6 text-6xl">ğŸ“</div>
            <h1 class="text-3xl font-bold text-blue-600 mb-2">å…¨èƒ½æ•¸å­¸ç‹</h1>
            <p class="text-gray-500 mb-8">é¸æ“‡ä¸€å€‹ä¸»é¡Œé–‹å§‹æŒ‘æˆ°</p>
            <div class="space-y-4">
                <button onclick="selectTopic('math')" class="w-full py-6 rounded-2xl text-xl font-bold bg-blue-500 text-white shadow-lg active:scale-95">â• åŸºç¤å››å‰‡é‹ç®—</button>
                <button onclick="selectTopic('length')" class="w-full py-6 rounded-2xl text-xl font-bold bg-orange-400 text-white shadow-lg active:scale-95">ğŸ“ é•·åº¦é€²ä½æ›ç®—</button>
                <button onclick="selectTopic('fraction')" class="w-full py-6 rounded-2xl text-xl font-bold bg-green-500 text-white shadow-lg active:scale-95">ğŸ° åˆ†æ•¸åŸºç¤ç·´ç¿’</button>
            </div>
        </div>

        <div id="grade-screen" class="game-card p-10 text-center hidden">
            <button onclick="backToTopic()" class="text-gray-400 mb-4 block hover:text-gray-600 font-bold">â† è¿”å›é¸å–®</button>
            <h2 id="grade-title" class="text-2xl font-bold mb-6">é›£åº¦é¸æ“‡</h2>
            <div class="space-y-4">
                <button onclick="startGame('2')" class="w-full py-5 rounded-2xl text-xl font-bold bg-emerald-500 text-white shadow-md active:scale-95">äºŒå¹´ç´š (15ç§’)</button>
                <button onclick="startGame('3')" class="w-full py-5 rounded-2xl text-xl font-bold bg-sky-500 text-white shadow-md active:scale-95">ä¸‰å¹´ç´š (30ç§’)</button>
                <button onclick="startGame('4')" class="w-full py-5 rounded-2xl text-xl font-bold bg-indigo-600 text-white shadow-md active:scale-95">å››å¹´ç´š (45ç§’)</button>
            </div>
        </div>

        <div id="game-screen" class="game-card p-6 hidden relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-gray-100">
                <div id="timer-bar" class="h-full bg-red-500 timer-bar" style="width: 100%"></div>
            </div>

            <div class="flex justify-between items-center mb-6 mt-4">
                <span id="q-label" class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full text-xs font-bold">Q 1/10</span>
                <span id="timer-text" class="font-bold text-red-600 text-xl">--s</span>
                <span class="text-gray-600 font-bold">Score: <span id="score-display" class="text-green-600">0</span></span>
            </div>

            <div class="flex flex-col items-center justify-center min-h-[320px] mb-6">
                <div id="visual-hint" class="mb-4 h-16 flex items-center justify-center"></div>

                <div id="question-text" class="text-4xl font-bold text-gray-800 mb-8 text-center leading-relaxed"></div>
                
                <div id="ui-standard" class="hidden flex flex-col items-center">
                    <input type="number" id="ans-main" inputmode="numeric" class="w-48 text-4xl p-4" placeholder="?">
                    <div id="remainder-box" class="hidden mt-4 flex items-center space-x-2">
                        <span class="text-2xl font-bold text-blue-400">é¤˜</span>
                        <input type="number" id="ans-rem" inputmode="numeric" class="w-24 text-center text-3xl p-2" placeholder="?">
                    </div>
                </div>

                <div id="ui-fraction" class="hidden flex flex-col items-center">
                    <input type="number" id="ans-num" inputmode="numeric" class="w-24 text-3xl p-2" placeholder="åˆ†å­">
                    <div class="fraction-line"></div>
                    <input type="number" id="ans-den" inputmode="numeric" class="w-24 text-3xl p-2" placeholder="åˆ†æ¯">
                </div>
            </div>

            <button id="submit-btn" onclick="checkAnswer()" class="w-full py-4 rounded-2xl text-xl font-bold bg-blue-600 text-white shadow-lg">é€å‡ºç­”æ¡ˆ</button>

            <div id="feedback" class="hidden absolute inset-0 bg-white/95 flex flex-col items-center justify-center z-50">
                <div id="feedback-icon" class="text-8xl mb-4"></div>
                <h2 id="feedback-text" class="text-3xl font-bold mb-2"></h2>
                <p id="correct-answer-text" class="text-xl text-gray-600 mb-8"></p>
                <button id="next-btn" onclick="nextQuestion()" class="bg-blue-500 text-white px-16 py-4 rounded-xl text-xl font-bold">ä¸‹ä¸€é¡Œ</button>
            </div>
        </div>

        <div id="result-screen" class="game-card p-8 text-center hidden">
            <div id="medal-icon" class="text-7xl mb-2">ğŸ…</div>
            <h2 id="rank-text" class="text-2xl font-bold text-blue-600 mb-2">è©•åƒ¹ä¸­...</h2>
            <div class="text-5xl font-bold mb-6"><span id="final-score">0</span> åˆ†</div>
            
            <div class="text-left mb-6">
                <h3 class="font-bold text-red-500 mb-2 border-b pb-1">éœ€åŠ å¼·çš„é¡Œç›®ï¼š</h3>
                <div class="max-h-40 overflow-y-auto pr-2 text-sm text-gray-600" id="wrong-list"></div>
            </div>
            <button onclick="window.location.reload()" class="w-full py-4 rounded-2xl text-xl font-bold bg-gray-800 text-white">å†è©¦ä¸€æ¬¡</button>
        </div>
    </div>

    <script>
        let currentTopic = '', audioCtx = null, timerId = null, timeLeft = 15, timeLimitPerQ = 15;
        let score = 0, currentIdx = 0, questions = [], wrongAnswers = [];

        // --- å‡ç´š2ï¼šè‡ªå‹•è·³æ ¼æ©Ÿåˆ¶ ---
        document.addEventListener('input', function(e) {
            if (e.target.id === 'ans-num' && e.target.value.length >= 1) {
                // åˆ†æ•¸å¡«å®Œåˆ†å­è‡ªå‹•è·³åˆ†æ¯
                e.target.addEventListener('keydown', function(k) {
                    if (k.key === 'Enter') document.getElementById('ans-den').focus();
                });
            }
            if (e.target.id === 'ans-main' && document.getElementById('remainder-box').className.indexOf('hidden') === -1) {
                // æœ‰é¤˜æ•¸é¡Œå¡«å®Œå•†æŒ‰ Enter è·³é¤˜æ•¸
                e.target.addEventListener('keydown', function(k) {
                    if (k.key === 'Enter') { k.preventDefault(); document.getElementById('ans-rem').focus(); }
                });
            }
        });

        function selectTopic(topic) {
            currentTopic = topic;
            document.getElementById('topic-screen').classList.add('hidden');
            document.getElementById('grade-screen').classList.remove('hidden');
        }

        function backToTopic() {
            document.getElementById('grade-screen').classList.add('hidden');
            document.getElementById('topic-screen').classList.remove('hidden');
        }

        function startGame(grade) {
            const g = parseInt(grade);
            timeLimitPerQ = g === 2 ? 15 : (g === 3 ? 30 : 45);
            score = 0; currentIdx = 0; wrongAnswers = [];
            document.getElementById('grade-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            questions = [];
            for(let i=0; i<10; i++) {
                if(currentTopic === 'math') questions.push(genMathQ(grade));
                else if(currentTopic === 'length') questions.push(genLengthQ(grade));
                else questions.push(genFractionQ(grade));
            }
            loadQuestion();
        }

        function rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

        function genMathQ(grade) {
            const types = (grade === '2') ? ['+', '-', '*'] : ['+', '-', '*', '/'];
            const type = types[Math.floor(Math.random() * types.length)];
            let a, b, q, ans, r = 0;
            if (grade === '2') {
                if (type === '+') { a = rand(10, 99); b = rand(10, 99); ans = a + b; q = a + " + " + b; }
                else if (type === '-') { a = rand(50, 99); b = rand(10, 49); ans = a - b; q = a + " - " + b; }
                else { a = rand(2, 5); b = rand(2, 9); ans = a * b; q = a + " Ã— " + b; }
            } else if (grade === '3') {
                if (type === '+') { a = rand(100, 999); b = rand(100, 999); ans = a + b; q = a + " + " + b; }
                else if (type === '-') { a = rand(500, 999); b = rand(100, 499); ans = a - b; q = a + " - " + b; }
                else if (type === '*') { a = rand(2, 9); b = rand(11, 99); ans = a * b; q = a + " Ã— " + b; }
                else { b = rand(2, 9); ans = rand(2, 20); a = ans * b; q = a + " Ã· " + b; }
            } else {
                if (type === '+') { a = rand(1000, 9999); b = rand(1000, 9999); ans = a + b; q = a + " + " + b; }
                else if (type === '-') { a = rand(5000, 9999); b = rand(1000, 4999); ans = a - b; q = a + " - " + b; }
                else if (type === '*') { a = rand(11, 99); b = rand(11, 50); ans = a * b; q = a + " Ã— " + b; }
                else { b = rand(3, 9); a = rand(20, 99); ans = Math.floor(a / b); r = a % b; q = a + " Ã· " + b; }
            }
            return { q, ans, r, isRem: (type === '/' && r > 0), type: 'math' };
        }

        function genLengthQ(grade) {
            const units = [{n: 'å…¬é‡Œ', v: 1000000}, {n: 'å…¬å°º', v: 1000}, {n: 'å…¬åˆ†', v: 10}, {n: 'æ¯«ç±³', v: 1}];
            let r1, r2, val;
            if(grade === '2') { r1=2; r2=3; val=rand(2, 20); }
            else if(grade === '3') { r1=1; r2=2; val=rand(2, 50); }
            else { r1=0; r2=1; val=rand(2, 10); }
            return { q: val + " " + units[r1].n + " = (?) " + units[r2].n, ans: val * (units[r1].v / units[r2].v), type: 'length' };
        }

        function genFractionQ(grade) {
            let n1, n2, den, q, ansNum, ansDen;
            if(grade === '2') {
                den = rand(3, 6); n1 = 1; n2 = 1;
                q = n1 + "/" + den + " + " + n2 + "/" + den + " = ?";
                ansNum = 2; ansDen = den;
            } else if(grade === '3') {
                den = rand(5, 10); n1 = rand(2, 4); n2 = 1;
                q = n1 + "/" + den + " - " + n2 + "/" + den + " = ?";
                ansNum = n1 - n2; ansDen = den;
            } else {
                const whole = rand(1, 2); den = rand(2, 5); n1 = 1;
                q = whole + " åˆ " + n1 + "/" + den + " åŒ–ç‚ºå‡åˆ†æ•¸";
                ansNum = whole * den + n1; ansDen = den;
            }
            return { q, ansNum, ansDen, type: 'fraction' };
        }

        function loadQuestion() {
            const data = questions[currentIdx];
            timeLeft = timeLimitPerQ;
            document.getElementById('feedback').classList.add('hidden');
            document.getElementById('q-label').innerText = "Q " + (currentIdx + 1) + "/10";
            document.getElementById('score-display').innerText = score;
            document.getElementById('question-text').innerHTML = data.q;

            // --- å‡ç´š1ï¼šè¦–è¦ºå¼•å°è¼”åŠ© ---
            const vHint = document.getElementById('visual-hint');
            vHint.innerHTML = "";
            if (data.type === 'length') {
                vHint.innerHTML = "<div class='unit-step text-orange-500 font-bold'>æç¤ºï¼šå…¬é‡Œ â”(1000)â” å…¬å°º â”(100)â” å…¬åˆ† â”(10)â” æ¯«ç±³</div>";
            } else if (data.type === 'fraction') {
                vHint.innerHTML = "<div class='text-green-500 font-bold'>ğŸ° è¨˜å¾—ï¼šåˆ†æ¯ä¸è®Šï¼Œåˆ†å­ç›¸åŠ æ¸›å–”ï¼</div>";
            }

            document.getElementById('ui-standard').classList.add('hidden');
            document.getElementById('ui-fraction').classList.add('hidden');
            document.getElementById('remainder-box').classList.add('hidden');

            if(data.type === 'math' || data.type === 'length') {
                document.getElementById('ui-standard').classList.remove('hidden');
                document.getElementById('ans-main').value = '';
                document.getElementById('ans-rem').value = '';
                if(data.isRem) document.getElementById('remainder-box').classList.remove('hidden');
                setTimeout(() => document.getElementById('ans-main').focus(), 150);
            } else {
                document.getElementById('ui-fraction').classList.remove('hidden');
                document.getElementById('ans-num').value = '';
                document.getElementById('ans-den').value = '';
                setTimeout(() => document.getElementById('ans-num').focus(), 150);
            }
            updateTimerUI(); startTimer();
        }

        function startTimer() {
            clearInterval(timerId);
            timerId = setInterval(() => {
                timeLeft--; updateTimerUI();
                if(timeLeft <= 0) { clearInterval(timerId); checkAnswer(true); }
            }, 1000);
        }

        function updateTimerUI() {
            document.getElementById('timer-text').innerText = timeLeft + "s";
            document.getElementById('timer-bar').style.width = (timeLeft / timeLimitPerQ * 100) + "%";
        }

        function checkAnswer(isTimeout = false) {
            clearInterval(timerId);
            const data = questions[currentIdx];
            let isCorrect = false, uStr = "", cStr = "";

            if(data.type === 'math' || data.type === 'length') {
                const uVal = parseInt(document.getElementById('ans-main').value);
                const uRem = parseInt(document.getElementById('ans-rem').value) || 0;
                if(!isTimeout) isCorrect = data.isRem ? (uVal===data.ans && uRem===data.r) : (uVal===data.ans);
                uStr = isTimeout ? "è¶…æ™‚" : (data.isRem ? uVal+"é¤˜"+uRem : (isNaN(uVal)?"?":uVal));
                cStr = data.isRem ? data.ans+"é¤˜"+data.r : data.ans;
            } else {
                const uNum = parseInt(document.getElementById('ans-num').value);
                const uDen = parseInt(document.getElementById('ans-den').value);
                if(!isTimeout) isCorrect = (uNum === data.ansNum && uDen === data.ansDen);
                uStr = isTimeout ? "è¶…æ™‚" : uNum+"/"+uDen;
                cStr = data.ansNum+"/"+data.ansDen;
            }

            document.getElementById('feedback').classList.remove('hidden');
            if(isCorrect) {
                score += 10; playTone(880, 'sine', 0.2);
                document.getElementById('feedback-icon').innerText = "ğŸŒŸ";
                document.getElementById('feedback-text').innerText = "å¤ªæ£’äº†ï¼";
                document.getElementById('correct-answer-text').innerText = "ç²¾æº–åˆå¿«é€Ÿï¼";
            } else {
                playTone(200, 'square', 0.3);
                wrongAnswers.push({ q: data.q, a: cStr, u: uStr });
                document.getElementById('feedback-icon').innerText = "ğŸ’¡";
                document.getElementById('feedback-text').innerText = "å†æª¢æŸ¥çœ‹çœ‹";
                document.getElementById('correct-answer-text').innerText = "æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š" + cStr;
            }
        }

        function nextQuestion() {
            currentIdx++;
            if(currentIdx < 10) loadQuestion();
            else showResult();
        }

        // --- å‡ç´š3ï¼šæˆå°±è©•åƒ¹ç³»çµ± ---
        function showResult() {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = score;
            
            let medal = "ğŸ¥‰", rank = "å†æ¥å†å²ï¼";
            if(score === 100) { medal="ğŸ†"; rank="æ•¸å­¸å°ç²¾éˆï¼å®Œç¾ï¼"; }
            else if(score >= 80) { medal="ğŸ¥ˆ"; rank="é‹ç®—é«˜æ‰‹ï¼å¤ªæ£’äº†"; }
            else if(score >= 60) { medal="ğŸ¥‰"; rank="åŠæ ¼äº†ï¼ç¹¼çºŒåŠ æ²¹"; }
            
            document.getElementById('medal-icon').innerText = medal;
            document.getElementById('rank-text').innerText = rank;

            const list = document.getElementById('wrong-list');
            list.innerHTML = wrongAnswers.length ? "" : "<p class='text-green-600 font-bold'>å…¨éƒ¨æ­£ç¢ºï¼ä½ å¤ªå¼·äº†ï¼</p>";
            wrongAnswers.forEach(w => {
                list.innerHTML += `<div class='border-b py-2'>é¡Œï¼š${w.q}<br><span class='text-red-400'>ä½ ç­”ï¼š${w.u}</span> | <span class='text-blue-500 font-bold'>æ­£è§£ï¼š${w.a}</span></div>`;
            });
        }

        function playTone(freq, type, dur) {
            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') audioCtx.resume();
                const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
                osc.type = type; osc.frequency.value = freq;
                gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(); osc.stop(audioCtx.currentTime + dur);
            } catch(e) {}
        }
    </script>
</body>
</html>