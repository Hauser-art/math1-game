<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å…¨èƒ½æ•¸å­¸ç‹ V4 - çµ‚æ¥µé›£åº¦ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; touch-action: manipulation; }
        .game-card { background: white; border-radius: 24px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); width: 100%; max-width: 480px; }
        .timer-bar { transition: width 1s linear; }
        .hidden { display: none !important; }
        input { -webkit-appearance: none; border-radius: 12px; outline: none; border: 3px solid #e2e8f0; text-align: center; transition: all 0.2s; font-weight: bold; }
        input:focus { border-color: #3b82f6; background-color: #eff6ff; transform: scale(1.02); }
        .fraction-line { width: 100%; height: 4px; background-color: #333; margin: 6px 0; border-radius: 2px; }
        .btn-topic { transition: transform 0.1s; }
        .btn-topic:active { transform: scale(0.95); }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div id="app" class="w-full flex justify-center">
        
        <div id="topic-screen" class="game-card p-10 text-center">
            <div class="mb-4 text-7xl">ğŸ§¬</div>
            <h1 class="text-3xl font-bold text-slate-800 mb-2">å…¨èƒ½æ•¸å­¸ç‹</h1>
            <p class="text-slate-500 mb-8">æŒ‘æˆ°ä½ çš„è…¦åŠ›æ¥µé™</p>
            <div class="space-y-4">
                <button onclick="selectTopic('math')" class="btn-topic w-full py-6 rounded-2xl text-xl font-bold bg-blue-500 text-white shadow-lg">â• åŸºç¤å››å‰‡é‹ç®—</button>
                <button onclick="selectTopic('length')" class="btn-topic w-full py-6 rounded-2xl text-xl font-bold bg-orange-500 text-white shadow-lg">ğŸ“ é•·åº¦è·¨ç´šæ›ç®—</button>
                <button onclick="selectTopic('fraction')" class="btn-topic w-full py-6 rounded-2xl text-xl font-bold bg-emerald-600 text-white shadow-lg">ğŸ° åˆ†æ•¸é€²éšç·´ç¿’</button>
            </div>
        </div>

        <div id="grade-screen" class="game-card p-10 text-center hidden">
            <button onclick="backToTopic()" class="text-slate-400 mb-6 block font-bold hover:text-slate-600">â† è¿”å›å–®å…ƒé¸æ“‡</button>
            <h2 id="grade-title" class="text-2xl font-bold mb-8 text-slate-700">é¸æ“‡æŒ‘æˆ°ç­‰ç´š</h2>
            <div class="space-y-4">
                <button onclick="startGame('2')" class="w-full py-5 rounded-2xl text-xl font-bold bg-green-500 text-white shadow-md">äºŒå¹´ç´š (15ç§’)</button>
                <button onclick="startGame('3')" class="w-full py-5 rounded-2xl text-xl font-bold bg-sky-500 text-white shadow-md">ä¸‰å¹´ç´š (30ç§’)</button>
                <button onclick="startGame('4')" class="w-full py-5 rounded-2xl text-xl font-bold bg-purple-700 text-white shadow-md">å››å¹´ç´š (45ç§’ - å›°é›£)</button>
            </div>
        </div>

        <div id="game-screen" class="game-card p-6 hidden relative overflow-hidden">
            <div class="absolute top-0 left-0 w-full h-2 bg-slate-100">
                <div id="timer-bar" class="h-full bg-red-500 timer-bar" style="width: 100%"></div>
            </div>

            <div class="flex justify-between items-center mb-6 mt-4">
                <span id="q-label" class="bg-slate-100 text-slate-600 px-3 py-1 rounded-full text-xs font-bold">ç¬¬ 1 / 10 é¡Œ</span>
                <span id="timer-text" class="font-bold text-red-600 text-xl">--s</span>
                <span class="text-slate-600 font-bold">å¾—åˆ†: <span id="score-display" class="text-green-600">0</span></span>
            </div>

            <div class="flex flex-col items-center justify-center min-h-[340px] mb-6 px-4">
                <div id="visual-hint" class="mb-4 text-center"></div>
                <div id="question-text" class="text-3xl font-bold text-slate-800 mb-10 text-center leading-relaxed"></div>
                
                <div id="ui-standard" class="hidden flex flex-col items-center">
                    <input type="number" id="ans-main" inputmode="numeric" class="w-56 text-5xl p-4" placeholder="?">
                    <div id="remainder-box" class="hidden mt-6 flex items-center space-x-3">
                        <span class="text-2xl font-bold text-blue-500">é¤˜æ•¸</span>
                        <input type="number" id="ans-rem" inputmode="numeric" class="w-28 text-center text-4xl p-2" placeholder="?">
                    </div>
                </div>

                <div id="ui-fraction" class="hidden flex flex-col items-center">
                    <input type="number" id="ans-num" inputmode="numeric" class="w-28 text-4xl p-2" placeholder="åˆ†å­">
                    <div class="fraction-line"></div>
                    <input type="number" id="ans-den" inputmode="numeric" class="w-28 text-4xl p-2" placeholder="åˆ†æ¯">
                </div>
            </div>

            <button id="submit-btn" onclick="checkAnswer()" class="w-full py-5 rounded-2xl text-2xl font-bold bg-blue-600 text-white shadow-xl active:bg-blue-700">é€ å‡º ç­” æ¡ˆ</button>

            <div id="feedback" class="hidden absolute inset-0 bg-white/fb flex flex-col items-center justify-center z-50">
                <div id="feedback-icon" class="text-9xl mb-6"></div>
                <h2 id="feedback-text" class="text-4xl font-bold mb-4"></h2>
                <p id="correct-answer-text" class="text-2xl text-slate-500 mb-10"></p>
                <button onclick="nextQuestion()" class="bg-slate-800 text-white px-20 py-4 rounded-2xl text-2xl font-bold">ä¸‹ä¸€é¡Œ</button>
            </div>
        </div>

        <div id="result-screen" class="game-card p-10 text-center hidden">
            <div id="medal-icon" class="text-8xl mb-4">ğŸ–ï¸</div>
            <h2 id="rank-text" class="text-3xl font-bold text-slate-800 mb-2">è©•åƒ¹ä¸­...</h2>
            <div class="text-6xl font-bold text-blue-600 mb-8"><span id="final-score">0</span> åˆ†</div>
            
            <div class="text-left mb-8 bg-slate-50 p-4 rounded-xl">
                <h3 class="font-bold text-red-500 mb-3 border-b border-red-200 pb-2">éŒ¯èª¤é¡Œç›®ç´€éŒ„ï¼š</h3>
                <div class="max-h-48 overflow-y-auto pr-2 text-base text-slate-600" id="wrong-list"></div>
            </div>
            <button onclick="window.location.reload()" class="w-full py-5 rounded-2xl text-2xl font-bold bg-blue-600 text-white shadow-lg">è¿”å›ä¸»é¸å–®</button>
        </div>
    </div>

    <script>
        let currentTopic = '', audioCtx = null, timerId = null, timeLeft = 15, timeLimitPerQ = 15;
        let score = 0, currentIdx = 0, questions = [], wrongAnswers = [];

        // è‡ªå‹•è·³æ ¼é‚è¼¯
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') {
                const active = document.activeElement;
                if (active.id === 'ans-num') document.getElementById('ans-den').focus();
                else if (active.id === 'ans-main' && !document.getElementById('remainder-box').classList.contains('hidden')) {
                    document.getElementById('ans-rem').focus();
                } else {
                    checkAnswer();
                }
            }
        });

        function selectTopic(topic) {
            currentTopic = topic;
            document.getElementById('topic-screen').classList.add('hidden');
            document.getElementById('grade-screen').classList.remove('hidden');
        }

        function backToTopic() {
            document.getElementById('grade-screen').classList.add('hidden');
            document.getElementById('topic-screen').classList.remove('hidden');
        }

        function startGame(grade) {
            const g = parseInt(grade);
            timeLimitPerQ = g === 2 ? 15 : (g === 3 ? 30 : 45);
            score = 0; currentIdx = 0; wrongAnswers = [];
            document.getElementById('grade-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
            questions = [];
            for(let i=0; i<10; i++) {
                if(currentTopic === 'math') questions.push(genMathQ(grade));
                else if(currentTopic === 'length') questions.push(genLengthQ(grade));
                else questions.push(genFractionQ(grade));
            }
            loadQuestion();
        }

        function rand(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

        function genMathQ(grade) {
            const types = (grade === '2') ? ['+', '-', '*'] : ['+', '-', '*', '/'];
            const type = types[Math.floor(Math.random() * types.length)];
            let a, b, q, ans, r = 0;
            if (grade === '2') {
                if (type === '+') { a = rand(10, 99); b = rand(10, 99); ans = a+b; q = a+" + "+b; }
                else if (type === '-') { a = rand(50, 99); b = rand(10, 49); ans = a-b; q = a+" - "+b; }
                else { a = rand(2, 5); b = rand(2, 9); ans = a*b; q = a+" Ã— "+b; }
            } else if (grade === '3') {
                if (type === '+') { a = rand(100, 999); b = rand(100, 999); ans = a+b; q = a+" + "+b; }
                else if (type === '-') { a = rand(500, 999); b = rand(100, 499); ans = a-b; q = a+" - "+b; }
                else if (type === '*') { a = rand(2, 9); b = rand(11, 99); ans = a*b; q = a+" Ã— "+b; }
                else { b = rand(2, 9); a = rand(20, 150); ans = Math.floor(a/b); r = a%b; q = a+" Ã· "+b; }
            } else {
                if (type === '+') { a = rand(1000, 9999); b = rand(1000, 9999); ans = a+b; q = a+" + "+b; }
                else if (type === '-') { a = rand(5000, 9999); b = rand(1000, 4999); ans = a-b; q = a+" - "+b; }
                else if (type === '*') { a = rand(100, 400); b = rand(11, 25); ans = a*b; q = a+" Ã— "+b; }
                else { b = rand(11, 35); a = rand(500, 1500); ans = Math.floor(a/b); r = a%b; q = a+" Ã· "+b; }
            }
            return { q, ans, r, isRem: (type === '/' && r > 0), type: 'math' };
        }

        function genLengthQ(grade) {
            let q, ans;
            if (grade === '2') {
                let cm = rand(2, 15), mm = rand(1, 9);
                q = cm + " å…¬åˆ† " + mm + " æ¯«ç±³ = (?) æ¯«ç±³";
                ans = cm * 10 + mm;
            } else if (grade === '3') {
                let m = rand(1, 9), cm = rand(1, 99);
                q = m + " å…¬å°º " + cm + " å…¬åˆ† = (?) å…¬åˆ†";
                ans = m * 100 + cm;
            } else {
                // å››å¹´ç´šï¼šçµ‚æ¥µè·¨åº¦æŒ‘æˆ°
                let r = Math.random();
                if (r < 0.3) {
                    let km = rand(1, 5);
                    q = "<span class='text-red-600 font-bold'>ã€è·¨ç´šæŒ‘æˆ°ã€‘</span><br>" + km + " å…¬é‡Œ = (?) å…¬é‡(æ¯«ç±³)";
                    ans = km * 1000000;
                } else if (r < 0.6) {
                    let km = rand(1, 9), m = rand(1, 99);
                    q = "<span class='text-orange-600 font-bold'>ã€è£œé›¶é™·é˜±ã€‘</span><br>" + km + " å…¬é‡Œ " + m + " å…¬å°º = (?) å…¬å°º";
                    ans = km * 1000 + m;
                } else {
                    let m = rand(11, 88);
                    q = m + " å…¬å°º = (?) å…¬é‡(æ¯«ç±³)";
                    ans = m * 1000;
                }
            }
            return { q, ans, type: 'length' };
        }

        function genFractionQ(grade) {
            let n1, n2, den, q, ansNum, ansDen;
            if(grade === '2') {
                den = rand(4, 9); n1 = rand(1, 2); n2 = rand(1, 2);
                q = n1+"/"+den + " + " + n2+"/"+den + " = ?";
                ansNum = n1+n2; ansDen = den;
            } else if(grade === '3') {
                den = rand(10, 25); n1 = rand(6, 9); n2 = rand(1, 5);
                q = n1+"/"+den + " - " + n2+"/"+den + " = ?";
                ansNum = n1-n2; ansDen = den;
            } else {
                // å››å¹´ç´šï¼šå€Ÿä½æŒ‘æˆ°
                den = rand(5, 15); n1 = rand(1, den-1);
                q = "<span class='text-indigo-600 font-bold'>ã€æ•´æ•¸å€Ÿä½ã€‘</span><br> 1 - " + n1+"/"+den + " = ?";
                ansNum = den - n1; ansDen = den;
            }
            return { q, ansNum, ansDen, type: 'fraction' };
        }

        function loadQuestion() {
            const data = questions[currentIdx];
            timeLeft = timeLimitPerQ;
            document.getElementById('feedback').classList.add('hidden');
            document.getElementById('q-label').innerText = "ç¬¬ " + (currentIdx + 1) + " / 10 é¡Œ";
            document.getElementById('score-display').innerText = score;
            document.getElementById('question-text').innerHTML = data.q;
            
            const vHint = document.getElementById('visual-hint');
            vHint.innerHTML = (data.type==='length') ? "<span class='text-xs font-bold text-orange-500'>1km=1000m / 1m=100cm / 1cm=10mm</span>" : "";

            document.getElementById('ui-standard').classList.add('hidden');
            document.getElementById('ui-fraction').classList.add('hidden');
            document.getElementById('remainder-box').classList.add('hidden');

            if (data.type !== 'fraction') {
                document.getElementById('ui-standard').classList.remove('hidden');
                document.getElementById('ans-main').value = '';
                document.getElementById('ans-rem').value = '';
                if(data.isRem) document.getElementById('remainder-box').classList.remove('hidden');
                setTimeout(() => document.getElementById('ans-main').focus(), 150);
            } else {
                document.getElementById('ui-fraction').classList.remove('hidden');
                document.getElementById('ans-num').value = '';
                document.getElementById('ans-den').value = '';
                setTimeout(() => document.getElementById('ans-num').focus(), 150);
            }
            updateTimerUI(); startTimer();
        }

        function startTimer() {
            clearInterval(timerId);
            timerId = setInterval(() => {
                timeLeft--; updateTimerUI();
                if(timeLeft <= 0) { clearInterval(timerId); checkAnswer(true); }
            }, 1000);
        }

        function updateTimerUI() {
            document.getElementById('timer-text').innerText = timeLeft + "s";
            document.getElementById('timer-bar').style.width = (timeLeft / timeLimitPerQ * 100) + "%";
        }

        function checkAnswer(isTimeout = false) {
            clearInterval(timerId);
            const data = questions[currentIdx];
            let isCorrect = false, uStr = "", cStr = "";

            if(data.type !== 'fraction') {
                const uVal = parseInt(document.getElementById('ans-main').value);
                const uRem = parseInt(document.getElementById('ans-rem').value) || 0;
                if(!isTimeout) isCorrect = data.isRem ? (uVal===data.ans && uRem===data.r) : (uVal===data.ans);
                uStr = isTimeout ? "è¶…æ™‚" : (data.isRem ? uVal+"é¤˜"+uRem : (isNaN(uVal)?"æœªå¡«":uVal));
                cStr = data.isRem ? data.ans+"é¤˜"+data.r : data.ans;
            } else {
                const uNum = parseInt(document.getElementById('ans-num').value);
                const uDen = parseInt(document.getElementById('ans-den').value);
                if(!isTimeout) isCorrect = (uNum === data.ansNum && uDen === data.ansDen);
                uStr = isTimeout ? "è¶…æ™‚" : uNum+"/"+uDen;
                cStr = data.ansNum+"/"+data.ansDen;
            }

            document.getElementById('feedback').classList.remove('hidden');
            if(isCorrect) {
                score += 10; playTone(880, 'sine', 0.2);
                document.getElementById('feedback-icon').innerText = "ğŸˆ";
                document.getElementById('feedback-text').innerText = "ç­”å°äº†ï¼";
                document.getElementById('correct-answer-text').innerText = "å¤ªå²å®³äº†ï¼Œç¹¼çºŒä¿æŒï¼";
            } else {
                playTone(200, 'square', 0.3);
                wrongAnswers.push({ q: data.q, a: cStr, u: uStr });
                document.getElementById('feedback-icon').innerText = "ğŸ§";
                document.getElementById('feedback-text').innerText = isTimeout ? "æ™‚é–“åˆ°ï¼" : "å†æƒ³ä¸€ä¸‹";
                document.getElementById('correct-answer-text').innerText = "æ­£ç¢ºç­”æ¡ˆæ˜¯ï¼š" + cStr;
            }
        }

        function nextQuestion() {
            currentIdx++;
            if(currentIdx < 10) loadQuestion();
            else showResult();
        }

        function showResult() {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.remove('hidden');
            document.getElementById('final-score').innerText = score;
            
            let medal = "ğŸ¥‰", rank = "å†å¤šç·´ç¿’ä¸€ä¸‹å§ï¼";
            if(score === 100) { medal="ğŸ†"; rank="æ•¸å­¸ä¹‹ç¥ï¼å¤ªå®Œç¾äº†ï¼"; }
            else if(score >= 80) { medal="ğŸ¥ˆ"; rank="æ•¸å­¸é«˜æ‰‹ï¼éå¸¸æœ‰æ°´æº–ï¼"; }
            else if(score >= 60) { medal="ğŸ¥‰"; rank="é‚„ä¸éŒ¯ï¼Œç¹¼çºŒåŠ æ²¹ï¼"; }
            
            document.getElementById('medal-icon').innerText = medal;
            document.getElementById('rank-text').innerText = rank;

            const list = document.getElementById('wrong-list');
            list.innerHTML = wrongAnswers.length ? "" : "<p class='text-green-600 font-bold'>å…¨éƒ¨æ­£ç¢ºï¼ä½ çœŸæ˜¯å€‹å¤©æ‰ï¼</p>";
            wrongAnswers.forEach(w => {
                list.innerHTML += `<div class='border-b py-2'>é¡Œï¼š${w.q}<br><span class='text-red-400'>ç­”ï¼š${w.u}</span> | <span class='text-blue-500 font-bold'>æ­£ç¢ºï¼š${w.a}</span></div>`;
            });
        }

        function playTone(freq, type, dur) {
            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') audioCtx.resume();
                const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
                osc.type = type; osc.frequency.value = freq;
                gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
                osc.connect(gain); gain.connect(audioCtx.destination);
                osc.start(); osc.stop(audioCtx.currentTime + dur);
            } catch(e) {}
        }
    </script>
</body>
</html>